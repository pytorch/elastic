


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>torchelastic.agent.server.api &mdash; PyTorch/Elastic master documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!-- <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" /> -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.0-beta/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/katex-math.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

  <!-- Preload the theme fonts -->

<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-book.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-Medium.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/FreightSans/freight-sans-medium-italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="../../../../_static/fonts/IBMPlexMono/IBMPlexMono-SemiBold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

<!-- Preload the katex fonts -->

<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Math-Italic.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Main-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size1-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size4-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size2-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Size3-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
<link rel="preload" href="https://cdn.jsdelivr.net/npm/katex@0.10.0/dist/fonts/KaTeX_Caligraphic-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css" integrity="sha384-vSIIfh2YWi9wW0r9iZe7RJPrKwp6bG+s9QZMoITbCckVJqGCCRhc+ccxNcdpHuYu" crossorigin="anonymous">
</head>

<div class="container-fluid header-holder tutorials-header" id="header-holder">
  <div class="container">
    <div class="header-container">
      <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>

      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-orange-arrow">
                Docs
              </a>
              <div class="resources-dropdown-menu">
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/docs/stable/index.html">
                  <span class="dropdown-title">PyTorch</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/audio/stable/index.html">
                  <span class="dropdown-title">torchaudio</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/text/stable/index.html">
                  <span class="dropdown-title">torchtext</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/vision/stable/index.html">
                  <span class="dropdown-title">torchvision</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/elastic/">
                  <span class="dropdown-title">TorchElastic</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/serve/">
                  <span class="dropdown-title">TorchServe</span>
                  <p></p>
                </a>
                <a class="doc-dropdown-option nav-dropdown-item" href="https://pytorch.org/xla">
                  <span class="dropdown-title">PyTorch on XLA Devices</span>
                  <p></p>
                </a>
            </div>
          </li>

          <li>
            <div id="resourcesDropdownButton" data-toggle="resources-dropdown" class="resources-dropdown">
              <a class="resource-option with-down-arrow">
                Resources
              </a>
              <div class="resources-dropdown-menu">
                <a class="nav-dropdown-item" href="https://pytorch.org/features">
                  <span class="dropdown-title">About</span>
                  <p>Learn about PyTorchâ€™s features and capabilities</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/#community-module">
                  <span class="dropdown-title">Community</span>
                  <p>Join the PyTorch developer community to contribute, learn, and get your questions answered.</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/resources">
                  <span class="dropdown-title">Developer Resources</span>
                  <p>Find resources and get questions answered</p>
                </a>
                <a class="nav-dropdown-item" href="https://discuss.pytorch.org/" target="_blank">
                  <span class="dropdown-title">Forums</span>
                  <p>A place to discuss PyTorch code, issues, install, research</p>
                </a>
                <a class="nav-dropdown-item" href="https://pytorch.org/hub">
                  <span class="dropdown-title">Models (Beta)</span>
                  <p>Discover, publish, and reuse pre-trained models</p>
                </a>
              </div>
            </div>
          </li>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>

      <a class="main-menu-open-button" href="#" data-behavior="open-mobile-menu"></a>
    </div>
  </div>
</div>

<body class="pytorch-body">

   

    

    <div class="table-of-contents-link-wrapper">
      <span>Table of Contents</span>
      <a href="#" class="toggle-table-of-contents" data-behavior="toggle-table-of-contents"></a>
    </div>

    <nav data-toggle="wy-nav-shift" class="pytorch-left-menu" id="pytorch-left-menu">
      <div class="pytorch-side-scroll">
        <div class="pytorch-menu pytorch-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          <div class="pytorch-left-menu-search">
            

            
              
              
                <div class="version">
                  v0.2.2
                </div>
              
            

            


  


<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search Docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

            
          </div>

          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Usage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../train_script.html">Train script</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../examples.html">Examples</a></li>
</ul>
<p class="caption"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../distributed.html">Elastic Launch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../agent.html">Elastic Agent</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../multiprocessing.html">Multiprocessing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../errors.html">Error Propagation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../rendezvous.html">Rendezvous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../timer.html">Expiration Timers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../metrics.html">Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../events.html">Events</a></li>
</ul>
<p class="caption"><span class="caption-text">Advanced</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../customization.html">Customization</a></li>
</ul>
<p class="caption"><span class="caption-text">Plugins</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../kubernetes.html">TorchElastic Kubernetes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../runtime.html">Cloud Provider Support (Deprecated)</a></li>
</ul>
<p class="caption"><span class="caption-text">Experimental</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../tsm_driver.html">Training Session Manager (TSM)</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <div class="pytorch-container">
      <div class="pytorch-page-level-bar" id="pytorch-page-level-bar">
        <div class="pytorch-breadcrumbs-wrapper">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="pytorch-breadcrumbs">
    
      <li>
        <a href="../../../../index.html">
          
            Docs
          
        </a> &gt;
      </li>

        
          <li><a href="../../../index.html">Module code</a> &gt;</li>
        
      <li>torchelastic.agent.server.api</li>
    
    
      <li class="pytorch-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
</div>
        </div>

        <div class="pytorch-shortcuts-wrapper" id="pytorch-shortcuts-wrapper">
          Shortcuts
        </div>
      </div>

      <section data-toggle="wy-nav-shift" id="pytorch-content-wrap" class="pytorch-content-wrap">
        <div class="pytorch-content-left">

        
          
          <div class="rst-content">
          
            <div role="main" class="main-content" itemscope="itemscope" itemtype="http://schema.org/Article">
             <article itemprop="articleBody" id="pytorch-article" class="pytorch-article">
              
  <h1>Source code for torchelastic.agent.server.api</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># Copyright (c) Facebook, Inc. and its affiliates.</span>
<span class="c1"># All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># This source code is licensed under the BSD-style license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>

<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Callable</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">torchelastic.rendezvous</span> <span class="k">as</span> <span class="nn">rdzv</span>
<span class="kn">import</span> <span class="nn">torchelastic.utils.store</span> <span class="k">as</span> <span class="nn">store_util</span>
<span class="kn">from</span> <span class="nn">torchelastic.events</span> <span class="kn">import</span> <span class="n">record</span><span class="p">,</span> <span class="n">Event</span><span class="p">,</span> <span class="n">EventSource</span>
<span class="kn">from</span> <span class="nn">torchelastic.metrics</span> <span class="kn">import</span> <span class="n">prof</span><span class="p">,</span> <span class="n">put_metric</span>
<span class="kn">from</span> <span class="nn">torchelastic.multiprocessing</span> <span class="kn">import</span> <span class="n">ProcessFailure</span><span class="p">,</span> <span class="n">Std</span>
<span class="kn">from</span> <span class="nn">torchelastic.utils.logging</span> <span class="kn">import</span> <span class="n">get_logger</span>


<span class="n">_TERMINAL_STATE_SYNC_ID</span> <span class="o">=</span> <span class="s2">&quot;torchelastic/agent/terminal_state&quot;</span>

<span class="n">DEFAULT_ROLE</span> <span class="o">=</span> <span class="s2">&quot;default&quot;</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">get_logger</span><span class="p">()</span>


<div class="viewcode-block" id="WorkerSpec"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.WorkerSpec">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">WorkerSpec</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Contains blueprint information about a particular type of worker.</span>
<span class="sd">    For a given role, there must only exist a single worker spec.</span>
<span class="sd">    Worker spec is expected to be homogenous across all nodes (machine),</span>
<span class="sd">    that is each node runs the same number of workers for a particular spec.</span>

<span class="sd">    Args:</span>
<span class="sd">        role: user-defined role for the workers with this spec</span>
<span class="sd">        local_world_size: number local workers to run</span>
<span class="sd">        fn: (deprecated use entrypoint instead)</span>
<span class="sd">        entrypoint: worker function or command</span>
<span class="sd">        args: arguments to pass to ``entrypoint``</span>
<span class="sd">        rdzv_handler: handles rdzv for this set of workers</span>
<span class="sd">        max_restarts: number of max retries for the workers</span>
<span class="sd">        monitor_interval: monitor status of workers every ``n`` seconds</span>
<span class="sd">        master_port: fixed port to run the c10d store on rank 0</span>
<span class="sd">                     if not specified then will chose a random free port</span>
<span class="sd">        redirects: redirect std streams to a file,</span>
<span class="sd">                   selectively redirect for a particular</span>
<span class="sd">                   local rank by passing a map</span>
<span class="sd">        tee: tees the specified std stream(s) to console + file,</span>
<span class="sd">             selectively tee for a particular local rank by passing a map,</span>
<span class="sd">             takes precedence over ``redirects`` settings.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">role</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">local_world_size</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">rdzv_handler</span><span class="p">:</span> <span class="n">rdzv</span><span class="o">.</span><span class="n">RendezvousHandler</span>
    <span class="n">fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># TODO @kiuk - make entrypoint a required field</span>
    <span class="n">entrypoint</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Callable</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="p">()</span>
    <span class="n">max_restarts</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">monitor_interval</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span>
    <span class="n">master_port</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">redirects</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Std</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Std</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Std</span><span class="o">.</span><span class="n">NONE</span>
    <span class="n">tee</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Std</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Std</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Std</span><span class="o">.</span><span class="n">NONE</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_world_size</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">monitor_interval</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;WorkerSpec.fn will be deprecated,&quot;</span>
                <span class="s2">&quot; please use WorkerSpec.entrypoint instead&quot;</span><span class="p">,</span>
                <span class="n">category</span><span class="o">=</span><span class="ne">DeprecationWarning</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fn</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span>

<div class="viewcode-block" id="WorkerSpec.get_entrypoint_name"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.WorkerSpec.get_entrypoint_name">[docs]</a>    <span class="k">def</span> <span class="nf">get_entrypoint_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If the entrypoint is a function (e.g. ``Callable``) returns its ``__qualname__``,</span>
<span class="sd">        else if the entrypoint is a binary (e.g. ``str``), returns the binary name.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">entrypoint</span><span class="o">.</span><span class="vm">__qualname__</span></div></div>


<div class="viewcode-block" id="Worker"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.Worker">[docs]</a><span class="k">class</span> <span class="nc">Worker</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a worker instance. Contrast this with ``WorkerSpec`` that</span>
<span class="sd">    represents the specifications of a worker. A ``Worker`` is created from</span>
<span class="sd">    a ``WorkerSpec``. A ``Worker`` is to a ``WorkerSpec`` as an object is to</span>
<span class="sd">    a class.</span>

<span class="sd">    The ``id`` of the worker is interpreted</span>
<span class="sd">    by the specific implementation of ``ElasticAgent``. For a local</span>
<span class="sd">    agent, it could be the ``pid (int)`` of the worker, for a remote</span>
<span class="sd">    agent it could be encoded as ``host:port (string)``.</span>

<span class="sd">    Args:</span>
<span class="sd">        id (Any): uniquely identifies a worker (interpreted by the agent)</span>
<span class="sd">        local_rank (int): local rank of the worker</span>
<span class="sd">        global_rank (int): global rank of the worker</span>
<span class="sd">        role_rank (int): rank of the worker across all workers that have the same role</span>
<span class="sd">        world_size (int): number of workers (globally)</span>
<span class="sd">        role_world_size (int): number of workers that have the same role</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;local_rank&quot;</span><span class="p">,</span>
        <span class="s2">&quot;global_rank&quot;</span><span class="p">,</span>
        <span class="s2">&quot;role_rank&quot;</span><span class="p">,</span>
        <span class="s2">&quot;world_size&quot;</span><span class="p">,</span>
        <span class="s2">&quot;role_world_size&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">local_rank</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">global_rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">role_rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">world_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">role_world_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># unique identifier for this worker</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># rank of the worker among workers with the same role being monitored</span>
        <span class="c1"># by the same ``agent`` instance.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">local_rank</span>

        <span class="c1">#  rank of the worker among all the workers across all roles</span>
        <span class="c1">#  across all ``agent`` instances.</span>
        <span class="c1">#  Global rank is not stable between re-rendezvous.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">global_rank</span>

        <span class="c1">#  rank of the worker among all the workers with the same role</span>
        <span class="c1">#  across all ``agent`` instances.</span>
        <span class="c1">#  Global rank is not stable between re-rendezvous.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role_rank</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">role_rank</span>

        <span class="c1"># total number of workers (globally). Due to elasticity</span>
        <span class="c1"># the world size may change between re-rendezvous.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">world_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">world_size</span>

        <span class="c1"># total number of workers that share the same role. Due to elasticity</span>
        <span class="c1"># the role world size may change between re-rendezvous.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">role_world_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">role_world_size</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;local_rank=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">local_rank</span><span class="si">}</span><span class="s2">,global_rank=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">global_rank</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;,role_rank=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">role_rank</span><span class="si">}</span><span class="s2">,world_size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">world_size</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;,role_world_size=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">role_world_size</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


<div class="viewcode-block" id="WorkerState"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.WorkerState">[docs]</a><span class="k">class</span> <span class="nc">WorkerState</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">Enum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    State of the ``WorkerGroup``. Workers in a worker group change state as a unit.</span>
<span class="sd">    If a single worker in a worker group fails the entire set is considered</span>
<span class="sd">    failed::</span>

<span class="sd">      UNKNOWN - agent lost track of worker group state, unrecoverable</span>
<span class="sd">      INIT - worker group object created not yet started</span>
<span class="sd">      HEALTHY - workers running and healthy</span>
<span class="sd">      UNHEALTHY - workers running and unhealthy</span>
<span class="sd">      STOPPED - workers stopped (interruped) by the agent</span>
<span class="sd">      SUCCEEDED - workers finished running (exit 0)</span>
<span class="sd">      FAILED - workers failed to successfully finish (exit !0)</span>


<span class="sd">    A worker group starts from an initial ``INIT`` state,</span>
<span class="sd">    then progresses to ``HEALTHY`` or ``UNHEALTHY`` states,</span>
<span class="sd">    and finally reaches a terminal ``SUCCEEDED`` or ``FAILED`` state.</span>

<span class="sd">    Worker groups can be interrupted and temporarily put into ``STOPPED`` state</span>
<span class="sd">    by the agent. Workers in ``STOPPED`` state are scheduled to be restarted</span>
<span class="sd">    in the near future by the agent. Some examples of workers being put into</span>
<span class="sd">    ``STOPPED`` state are:</span>

<span class="sd">    1. Worker group failure|unhealthy observed</span>
<span class="sd">    2. Membership change detected</span>

<span class="sd">    When actions (start, stop, rdzv, retry, etc) on worker group fails</span>
<span class="sd">    and results in the action being partially applied to the worker group</span>
<span class="sd">    the state will be ``UNKNOWN``. Typically this happens on uncaught/unhandled</span>
<span class="sd">    exceptions during state change events on the agent. The agent is not</span>
<span class="sd">    expected to recover worker groups in ``UNKNOWN`` state and is better off</span>
<span class="sd">    self terminating and allowing the job manager to retry the node.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">&quot;UNKNOWN&quot;</span>
    <span class="n">INIT</span> <span class="o">=</span> <span class="s2">&quot;INIT&quot;</span>
    <span class="n">HEALTHY</span> <span class="o">=</span> <span class="s2">&quot;HEALTHY&quot;</span>
    <span class="n">UNHEALTHY</span> <span class="o">=</span> <span class="s2">&quot;UNHEALTHY&quot;</span>
    <span class="n">STOPPED</span> <span class="o">=</span> <span class="s2">&quot;STOPPED&quot;</span>
    <span class="n">SUCCEEDED</span> <span class="o">=</span> <span class="s2">&quot;SUCCEEDED&quot;</span>
    <span class="n">FAILED</span> <span class="o">=</span> <span class="s2">&quot;FAILED&quot;</span>

<div class="viewcode-block" id="WorkerState.is_running"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.WorkerState.is_running">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_running</span><span class="p">(</span><span class="n">state</span><span class="p">:</span> <span class="s2">&quot;WorkerState&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">             True if the worker state represents workers still running</span>
<span class="sd">             (e.g. that the process exists but not necessarily healthy).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">{</span><span class="n">WorkerState</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">,</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">UNHEALTHY</span><span class="p">}</span></div></div>


<div class="viewcode-block" id="WorkerGroup"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.WorkerGroup">[docs]</a><span class="k">class</span> <span class="nc">WorkerGroup</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the set of ``Worker`` instances for the given ``WorkerSpec``</span>
<span class="sd">    managed by ``ElasticAgent``. Whether the worker group contains cross</span>
<span class="sd">    instance workers or not depends on the implementation of the agent.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;spec&quot;</span><span class="p">,</span> <span class="s2">&quot;workers&quot;</span><span class="p">,</span> <span class="s2">&quot;store&quot;</span><span class="p">,</span> <span class="s2">&quot;group_rank&quot;</span><span class="p">,</span> <span class="s2">&quot;group_world_size&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">WorkerSpec</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">spec</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workers</span> <span class="o">=</span> <span class="p">[</span><span class="n">Worker</span><span class="p">(</span><span class="n">local_rank</span><span class="o">=</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">local_world_size</span><span class="p">)]</span>

        <span class="c1"># assigned after rdzv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_rank</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">group_world_size</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">INIT</span></div>


<span class="k">class</span> <span class="nc">_RoleInstanceInfo</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The class is used by the agent to exchange the information with other agents.</span>
<span class="sd">    The information is used to determine the rank of the workers that agent</span>
<span class="sd">    manages in heterogeneous environments, where different agents can have</span>
<span class="sd">    different number of workers.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">,</span> <span class="s2">&quot;rank&quot;</span><span class="p">,</span> <span class="s2">&quot;local_world_size&quot;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">rank</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">local_world_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Args:</span>
<span class="sd">            role (str): user-defined role for the workers with this spec</span>
<span class="sd">            rank (int): the rank of the agent</span>
<span class="sd">            local_world_size (int): number of local workers to run</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rank</span> <span class="o">=</span> <span class="n">rank</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_world_size</span> <span class="o">=</span> <span class="n">local_world_size</span>

    <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bytes</span><span class="p">:</span>
        <span class="n">dict_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
            <span class="s2">&quot;rank&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rank</span><span class="p">,</span>
            <span class="s2">&quot;local_world_size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_world_size</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">dict_data</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">deserialize</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="n">dict_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">_RoleInstanceInfo</span><span class="p">(</span>
            <span class="n">dict_data</span><span class="p">[</span><span class="s2">&quot;role&quot;</span><span class="p">],</span> <span class="n">dict_data</span><span class="p">[</span><span class="s2">&quot;rank&quot;</span><span class="p">],</span> <span class="n">dict_data</span><span class="p">[</span><span class="s2">&quot;local_world_size&quot;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">obj1</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">obj2</span><span class="o">.</span><span class="n">role</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj1</span><span class="o">.</span><span class="n">rank</span> <span class="o">-</span> <span class="n">obj2</span><span class="o">.</span><span class="n">rank</span>
        <span class="k">elif</span> <span class="n">obj1</span><span class="o">.</span><span class="n">role</span> <span class="o">&gt;</span> <span class="n">obj2</span><span class="o">.</span><span class="n">role</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">find_role_boundaries</span><span class="p">(</span><span class="n">roles_infos</span><span class="p">:</span> <span class="n">List</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">role_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">roles_infos</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">role_info</span><span class="o">.</span><span class="n">role</span> <span class="o">==</span> <span class="n">role</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">start_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">start_idx</span> <span class="o">=</span> <span class="n">idx</span>
                <span class="n">end_idx</span> <span class="o">=</span> <span class="n">idx</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">)</span>


<div class="viewcode-block" id="RunResult"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.RunResult">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">RunResult</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Results returned by the worker executions. Run results follow an &quot;all-or-nothing&quot; policy</span>
<span class="sd">    where the run is successful if and only if ALL local workers managed by this agent</span>
<span class="sd">    complete successfully.</span>

<span class="sd">    If the result is successful (e.g. ``is_failed() = False``) then the ``return_values``</span>
<span class="sd">    field contains the outputs (return values) of the workers managed by THIS agent mapped</span>
<span class="sd">    by their GLOBAL ranks. That is ``result.return_values[0]`` is the return value of</span>
<span class="sd">    global rank 0.</span>

<span class="sd">    .. note:: ``return_values`` are only meaningful for when the worker entrypoint</span>
<span class="sd">              is a function. Workers specified as a binary entrypoint do not canonically</span>
<span class="sd">              have a return value and the ``return_values`` field is meaningless and</span>
<span class="sd">              may be empty.</span>

<span class="sd">    If ``is_failed()`` returns ``True`` then the ``failures`` field contains the</span>
<span class="sd">    failure information, again, mapped by the GLOBAL rank of the worker that failed.</span>

<span class="sd">    The keys in ``return_values`` and ``failures`` are mutually exclusive, that is,</span>
<span class="sd">    a worker&#39;s final state can only be one of: succeeded, failed. Workers intentionally</span>
<span class="sd">    terminated by the agent according to the agent&#39;s restart policy, are not represented</span>
<span class="sd">    in either ``return_values`` nor ``failures``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">state</span><span class="p">:</span> <span class="n">WorkerState</span>
    <span class="n">return_values</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">failures</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">ProcessFailure</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_failed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">FAILED</span></div>


<span class="k">def</span> <span class="nf">_get_socket_with_port</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a free port on localhost that is &quot;reserved&quot; by binding a temporary</span>
<span class="sd">    socket on it. Close the socket before passing the port to the entity</span>
<span class="sd">    that requires it. Usage example</span>

<span class="sd">    ::</span>

<span class="sd">    sock = _get_socket_with_port()</span>
<span class="sd">    with closing(sock):</span>
<span class="sd">        port = sock.getsockname()[1]</span>
<span class="sd">        sock.close()</span>
<span class="sd">        # there is still a race-condition that some other process</span>
<span class="sd">        # may grab this port before func() runs</span>
<span class="sd">        func(port)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">addrs</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">getaddrinfo</span><span class="p">(</span>
        <span class="n">host</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">family</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_UNSPEC</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span>
    <span class="p">)</span>
    <span class="k">for</span> <span class="n">addr</span> <span class="ow">in</span> <span class="n">addrs</span><span class="p">:</span>
        <span class="n">family</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">proto</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">addr</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">family</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">proto</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="s2">&quot;localhost&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="n">s</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">s</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Socket creation attempt failed.&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>
    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to create a socket&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_fq_hostname</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">socket</span><span class="o">.</span><span class="n">getfqdn</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">())</span>


<div class="viewcode-block" id="ElasticAgent"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.ElasticAgent">[docs]</a><span class="k">class</span> <span class="nc">ElasticAgent</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Agent process responsible for managing one or more worker processes.</span>
<span class="sd">    The worker processes are assumed to be regular distributed PyTorch scripts.</span>
<span class="sd">    When the worker process is created by the agent, the agent provides the</span>
<span class="sd">    necessary information for the worker processes to properly initialize</span>
<span class="sd">    a torch process group.</span>

<span class="sd">    The exact deployment topology and ratio of agent-to-worker is dependent</span>
<span class="sd">    on the specific implementation of the agent and the user&#39;s job placement</span>
<span class="sd">    preferences. For instance, to run a distributed training job on GPU with</span>
<span class="sd">    8 trainers (one per GPU) one can:</span>

<span class="sd">    1. Use 8 x single GPU instances, place an agent per instance, managing</span>
<span class="sd">       1 worker per agent.</span>
<span class="sd">    2. Use 4 x double GPU instances, place an agent per instance, managing</span>
<span class="sd">       2 workers per agent.</span>
<span class="sd">    3. Use 2 x quad GPU instances, place an agent per instance, managing</span>
<span class="sd">       4 workers per agent.</span>
<span class="sd">    4. Use 1 x 8 GPU instance, place an agent per instance, managing</span>
<span class="sd">       8 workers per agent.</span>

<span class="sd">    Usage</span>
<span class="sd">    ::</span>

<span class="sd">     group_result = agent.run()</span>
<span class="sd">      if group_result.is_failed():</span>
<span class="sd">        # workers failed</span>
<span class="sd">        failure = group_result.failures[0]</span>
<span class="sd">        log.exception(f&quot;worker 0 failed with exit code : {failure.exit_code}&quot;)</span>
<span class="sd">      else:</span>
<span class="sd">        return group_result.return_values[0] # return rank 0&#39;s results</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ElasticAgent.run"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.ElasticAgent.run">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_ROLE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunResult</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the agent, retrying the worker group on failures up to</span>
<span class="sd">        ``max_restarts``.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The result of the execution, containing the return values or</span>
<span class="sd">            failure details for each worker mapped by the worker&#39;s global rank.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Exception - any other failures NOT related to worker process</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="ElasticAgent.get_worker_group"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.ElasticAgent.get_worker_group">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">get_worker_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_ROLE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkerGroup</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns:</span>
<span class="sd">            The ``WorkerGroup`` for the given ``role``.</span>
<span class="sd">            Note that the worker group is a mutable object and hence in a</span>
<span class="sd">            multi-threaded/process environment it may change state.</span>
<span class="sd">            Implementors are encouraged (but not required) to return</span>
<span class="sd">            a defensive read-only copy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="SimpleElasticAgent"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent">[docs]</a><span class="k">class</span> <span class="nc">SimpleElasticAgent</span><span class="p">(</span><span class="n">ElasticAgent</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An ``ElasticAgent`` that manages workers (``WorkerGroup``)</span>
<span class="sd">    for a single ``WorkerSpec`` (e.g. one particular type of worker role).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">WorkerSpec</span><span class="p">,</span> <span class="n">exit_barrier_timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mi">300</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span> <span class="o">=</span> <span class="n">WorkerGroup</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_restarts</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">max_restarts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exit_barrier_timeout</span> <span class="o">=</span> <span class="n">exit_barrier_timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_total_execution_time</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="SimpleElasticAgent.get_worker_group"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent.get_worker_group">[docs]</a>    <span class="k">def</span> <span class="nf">get_worker_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_ROLE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WorkerGroup</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span></div>

<div class="viewcode-block" id="SimpleElasticAgent._start_workers"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent._start_workers">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_start_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_group</span><span class="p">:</span> <span class="n">WorkerGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts ``worker_group.spec.local_world_size`` number of workers</span>
<span class="sd">        according to worker spec for the worker group .</span>

<span class="sd">        Returns a map of ``local_rank`` to worker ``id``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="SimpleElasticAgent._stop_workers"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent._stop_workers">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_stop_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_group</span><span class="p">:</span> <span class="n">WorkerGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stops all workers in the given worker group. Implementors</span>
<span class="sd">        must deal with workers in all states defined by ``WorkerState``.</span>
<span class="sd">        That is, it must gracefully handle stopping non-existent workers,</span>
<span class="sd">        unhealthy (stuck) workers, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="SimpleElasticAgent._monitor_workers"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent._monitor_workers">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_monitor_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_group</span><span class="p">:</span> <span class="n">WorkerGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunResult</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks on the workers for the ``worker_group`` and returns</span>
<span class="sd">        the new state of the worker group.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

<div class="viewcode-block" id="SimpleElasticAgent._shutdown"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent._shutdown">[docs]</a>    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_shutdown</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Cleans up any resources that were allocated during the agent&#39;s work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_set_master_addr_port</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">master_port</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">master_port</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sock</span> <span class="o">=</span> <span class="n">_get_socket_with_port</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">sock</span><span class="p">):</span>
                <span class="n">master_port</span> <span class="o">=</span> <span class="n">sock</span><span class="o">.</span><span class="n">getsockname</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>

        <span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;MASTER_ADDR&quot;</span><span class="p">,</span> <span class="n">_get_fq_hostname</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>
        <span class="n">store</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;MASTER_PORT&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">master_port</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_master_addr_port</span><span class="p">(</span><span class="n">store</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
        <span class="n">master_addr</span> <span class="o">=</span> <span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MASTER_ADDR&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">)</span>
        <span class="n">master_port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">store</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;MASTER_PORT&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;UTF-8&quot;</span><span class="p">))</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">master_addr</span><span class="p">,</span> <span class="n">master_port</span><span class="p">)</span>

<div class="viewcode-block" id="SimpleElasticAgent._rendezvous"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent._rendezvous">[docs]</a>    <span class="nd">@prof</span>
    <span class="k">def</span> <span class="nf">_rendezvous</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_group</span><span class="p">:</span> <span class="n">WorkerGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs rendezvous for the workers specified by worker spec.</span>
<span class="sd">        Assigns workers a new global rank and world size.</span>
<span class="sd">        Updates the rendezvous store for the worker group.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="n">worker_group</span><span class="o">.</span><span class="n">spec</span>

        <span class="n">store</span><span class="p">,</span> <span class="n">group_rank</span><span class="p">,</span> <span class="n">group_world_size</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">rdzv_handler</span><span class="o">.</span><span class="n">next_rendezvous</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="o">=</span> <span class="n">store</span>

        <span class="n">workers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_worker_ranks</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">group_rank</span><span class="p">,</span> <span class="n">group_world_size</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
        <span class="n">worker_group</span><span class="o">.</span><span class="n">workers</span> <span class="o">=</span> <span class="n">workers</span>
        <span class="n">worker_group</span><span class="o">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">store</span>
        <span class="n">worker_group</span><span class="o">.</span><span class="n">group_rank</span> <span class="o">=</span> <span class="n">group_rank</span>
        <span class="n">worker_group</span><span class="o">.</span><span class="n">group_world_size</span> <span class="o">=</span> <span class="n">group_world_size</span>

        <span class="k">if</span> <span class="n">group_rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_master_addr_port</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">master_port</span><span class="p">)</span>
        <span class="n">master_addr</span><span class="p">,</span> <span class="n">master_port</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_master_addr_port</span><span class="p">(</span><span class="n">store</span><span class="p">)</span>
        <span class="n">restart_count</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">max_restarts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_restarts</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">role</span><span class="si">}</span><span class="s2">] Rendezvous complete for workers. Result:</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  restart_count=</span><span class="si">{</span><span class="n">restart_count</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  master_addr=</span><span class="si">{</span><span class="n">master_addr</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  master_port=</span><span class="si">{</span><span class="n">master_port</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  group_rank=</span><span class="si">{</span><span class="n">group_rank</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  group_world_size=</span><span class="si">{</span><span class="n">group_world_size</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  local_ranks=</span><span class="si">{</span><span class="p">[</span><span class="n">worker</span><span class="o">.</span><span class="n">local_rank</span> <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  role_ranks=</span><span class="si">{</span><span class="p">[</span><span class="n">worker</span><span class="o">.</span><span class="n">role_rank</span> <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  global_ranks=</span><span class="si">{</span><span class="p">[</span><span class="n">worker</span><span class="o">.</span><span class="n">global_rank</span> <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  role_world_sizes=</span><span class="si">{</span><span class="p">[</span><span class="n">worker</span><span class="o">.</span><span class="n">role_world_size</span> <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;  global_world_sizes=</span><span class="si">{</span><span class="p">[</span><span class="n">worker</span><span class="o">.</span><span class="n">world_size</span> <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="n">workers</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_ranks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">role_infos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">_RoleInstanceInfo</span><span class="p">],</span>
        <span class="n">role_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">start_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">end_idx</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]]:</span>
        <span class="k">if</span> <span class="n">end_idx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">end_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">role_infos</span><span class="p">)</span>
        <span class="n">prefix_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">total_sum</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">end_idx</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">role_idx</span> <span class="o">&gt;</span> <span class="n">idx</span><span class="p">:</span>
                <span class="n">prefix_sum</span> <span class="o">+=</span> <span class="n">role_infos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">local_world_size</span>
            <span class="n">total_sum</span> <span class="o">+=</span> <span class="n">role_infos</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">local_world_size</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">total_sum</span><span class="p">,</span>
            <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">prefix_sum</span><span class="p">,</span> <span class="n">prefix_sum</span> <span class="o">+</span> <span class="n">role_infos</span><span class="p">[</span><span class="n">role_idx</span><span class="p">]</span><span class="o">.</span><span class="n">local_world_size</span><span class="p">)),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="SimpleElasticAgent._assign_worker_ranks"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent._assign_worker_ranks">[docs]</a>    <span class="nd">@prof</span>
    <span class="k">def</span> <span class="nf">_assign_worker_ranks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">group_rank</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">group_world_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">WorkerSpec</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Worker</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines proper ranks for worker processes. The rank assignment</span>
<span class="sd">        is done according to the following algorithm:</span>

<span class="sd">        1. Each agent writes its configuration(group_rank, group_world_size</span>
<span class="sd">           , num_workers) to the common store.</span>
<span class="sd">        2. Each agent retrieves configuration for all agents</span>
<span class="sd">           and performs two level sort using role and rank.</span>
<span class="sd">        3. Determine the global rank: the global rank of the workers for the current</span>
<span class="sd">           agent is the offset of the infos array up to group_rank of the agent.</span>
<span class="sd">           The offset is computed as a sum of local_world_size of all agents that</span>
<span class="sd">           have rank less than the group_rank. The workers would have the ranks:</span>
<span class="sd">           [offset, offset+local_world_size)</span>
<span class="sd">        4. Determine the role rank: The role rank is determined using the algorithms</span>
<span class="sd">           in the point 3 with the exception that the offset is done from the first</span>
<span class="sd">           agent that has the same role as current one and has the minimum group rank.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">role_infos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_share_and_gather</span><span class="p">(</span><span class="n">store</span><span class="p">,</span> <span class="n">group_rank</span><span class="p">,</span> <span class="n">group_world_size</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
        <span class="n">my_role_info</span> <span class="o">=</span> <span class="n">role_infos</span><span class="p">[</span><span class="n">group_rank</span><span class="p">]</span>
        <span class="n">worker_world_size</span><span class="p">,</span> <span class="n">worker_global_ranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ranks</span><span class="p">(</span><span class="n">role_infos</span><span class="p">,</span> <span class="n">group_rank</span><span class="p">)</span>
        <span class="n">role_infos</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="n">role_infos</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">functools</span><span class="o">.</span><span class="n">cmp_to_key</span><span class="p">(</span><span class="n">_RoleInstanceInfo</span><span class="o">.</span><span class="n">compare</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">role_start_idx</span><span class="p">,</span> <span class="n">role_end_idx</span> <span class="o">=</span> <span class="n">_RoleInstanceInfo</span><span class="o">.</span><span class="n">find_role_boundaries</span><span class="p">(</span>
            <span class="n">role_infos</span><span class="p">,</span> <span class="n">my_role_info</span><span class="o">.</span><span class="n">role</span>
        <span class="p">)</span>
        <span class="n">role_pos</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span>
            <span class="n">idx</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">role_info</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">role_infos</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">_RoleInstanceInfo</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">role_info</span><span class="p">,</span> <span class="n">my_role_info</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="p">)</span>
        <span class="n">role_world_size</span><span class="p">,</span> <span class="n">role_ranks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ranks</span><span class="p">(</span>
            <span class="n">role_infos</span><span class="p">,</span> <span class="n">role_pos</span><span class="p">,</span> <span class="n">role_start_idx</span><span class="p">,</span> <span class="n">role_end_idx</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">workers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">local_world_size</span><span class="p">):</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="n">Worker</span><span class="p">(</span>
                <span class="n">local_rank</span><span class="o">=</span><span class="n">ind</span><span class="p">,</span>
                <span class="n">global_rank</span><span class="o">=</span><span class="n">worker_global_ranks</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span>
                <span class="n">role_rank</span><span class="o">=</span><span class="n">role_ranks</span><span class="p">[</span><span class="n">ind</span><span class="p">],</span>
                <span class="n">world_size</span><span class="o">=</span><span class="n">worker_world_size</span><span class="p">,</span>
                <span class="n">role_world_size</span><span class="o">=</span><span class="n">role_world_size</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">workers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">worker</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">workers</span></div>

    <span class="k">def</span> <span class="nf">_share_and_gather</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">store</span><span class="p">,</span> <span class="n">group_rank</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">group_world_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">spec</span><span class="p">:</span> <span class="n">WorkerSpec</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">:</span>
        <span class="n">agent_role_info</span> <span class="o">=</span> <span class="n">_RoleInstanceInfo</span><span class="p">(</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">role</span><span class="p">,</span> <span class="n">group_rank</span><span class="p">,</span> <span class="n">spec</span><span class="o">.</span><span class="n">local_world_size</span>
        <span class="p">)</span>
        <span class="n">key_prefix</span> <span class="o">=</span> <span class="s2">&quot;torchelastic/role_info&quot;</span>
        <span class="n">agent_config_enc</span> <span class="o">=</span> <span class="n">agent_role_info</span><span class="o">.</span><span class="n">serialize</span><span class="p">()</span>
        <span class="n">role_infos_bytes</span> <span class="o">=</span> <span class="n">store_util</span><span class="o">.</span><span class="n">synchronize</span><span class="p">(</span>
            <span class="n">store</span><span class="p">,</span> <span class="n">agent_config_enc</span><span class="p">,</span> <span class="n">group_rank</span><span class="p">,</span> <span class="n">group_world_size</span><span class="p">,</span> <span class="n">key_prefix</span>
        <span class="p">)</span>
        <span class="n">role_infos</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_RoleInstanceInfo</span><span class="o">.</span><span class="n">deserialize</span><span class="p">(</span><span class="n">role_info_bytes</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">role_info_bytes</span> <span class="ow">in</span> <span class="n">role_infos_bytes</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">role_infos</span>

<div class="viewcode-block" id="SimpleElasticAgent._initialize_workers"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent._initialize_workers">[docs]</a>    <span class="nd">@prof</span>
    <span class="k">def</span> <span class="nf">_initialize_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_group</span><span class="p">:</span> <span class="n">WorkerGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Starts a fresh set of workers for the worker_group.</span>
<span class="sd">        Essentially a rendezvous followed by a start_workers.</span>

<span class="sd">        The caller should first call ``_stop_workers()`` to stop running workers</span>
<span class="sd">        prior to calling this method.</span>

<span class="sd">        Optimistically sets the state of the worker group that</span>
<span class="sd">        just started as ``HEALTHY`` and delegates the actual monitoring</span>
<span class="sd">        of state to ``_monitor_workers()`` method</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">worker_group</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">role</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">] Rendezvous&#39;ing worker group&quot;</span><span class="p">)</span>

        <span class="c1"># TODO after stopping workers, wait at least monitor_interval*2 for</span>
        <span class="c1"># workers on different nodes to fail on a collective op before waiting</span>
        <span class="c1"># on the rdzv barrier, this way we ensure that nodes enter rdzv</span>
        <span class="c1"># at around the same time and reduce false positive rdzv timeout errors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rendezvous</span><span class="p">(</span><span class="n">worker_group</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">] Starting worker group&quot;</span><span class="p">)</span>
        <span class="n">worker_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_workers</span><span class="p">(</span><span class="n">worker_group</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">local_rank</span><span class="p">,</span> <span class="n">w_id</span> <span class="ow">in</span> <span class="n">worker_ids</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">worker</span> <span class="o">=</span> <span class="n">worker_group</span><span class="o">.</span><span class="n">workers</span><span class="p">[</span><span class="n">local_rank</span><span class="p">]</span>
            <span class="n">worker</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">w_id</span>

        <span class="n">worker_group</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">HEALTHY</span></div>

<div class="viewcode-block" id="SimpleElasticAgent._restart_workers"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent._restart_workers">[docs]</a>    <span class="nd">@prof</span>
    <span class="k">def</span> <span class="nf">_restart_workers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker_group</span><span class="p">:</span> <span class="n">WorkerGroup</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Restarts (stops, rendezvous, starts) all local workers in the group.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">role</span> <span class="o">=</span> <span class="n">worker_group</span><span class="o">.</span><span class="n">spec</span><span class="o">.</span><span class="n">role</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">] Stopping worker group&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_workers</span><span class="p">(</span><span class="n">worker_group</span><span class="p">)</span>
        <span class="n">worker_group</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">STOPPED</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_workers</span><span class="p">(</span><span class="n">worker_group</span><span class="p">)</span></div>

<div class="viewcode-block" id="SimpleElasticAgent.run"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent.run">[docs]</a>    <span class="nd">@prof</span>
    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_ROLE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunResult</span><span class="p">:</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_invoke_run</span><span class="p">(</span><span class="n">role</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_total_execution_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_record_metrics</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_record_worker_events</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># record the execution time in case there were any exceptions during run.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_total_execution_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">monotonic</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_shutdown</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">get_agent_status_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">WorkerState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Event</span><span class="p">:</span>
        <span class="n">raw_error</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span> <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">FAILED</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_construct_event</span><span class="p">(</span>
            <span class="n">state</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">EventSource</span><span class="o">.</span><span class="n">AGENT</span><span class="p">,</span> <span class="n">raw_error</span><span class="o">=</span><span class="n">raw_error</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_record_worker_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">RunResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">worker</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">workers</span><span class="p">:</span>
            <span class="n">failure</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">global_rank</span><span class="p">)</span>
            <span class="n">state</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_worker_state</span><span class="p">(</span><span class="n">worker</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
            <span class="n">raw_error</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">failure</span><span class="o">.</span><span class="n">error_file_data</span><span class="p">)</span> <span class="k">if</span> <span class="n">failure</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="n">record</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_construct_event</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">EventSource</span><span class="o">.</span><span class="n">WORKER</span><span class="p">,</span> <span class="n">worker</span><span class="p">,</span> <span class="n">raw_error</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_get_worker_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worker</span><span class="p">:</span> <span class="n">Worker</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="n">RunResult</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">failure</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">failures</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">global_rank</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">state</span> <span class="ow">in</span> <span class="p">{</span><span class="n">WorkerState</span><span class="o">.</span><span class="n">UNHEALTHY</span><span class="p">,</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">FAILED</span><span class="p">}</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">failure</span><span class="p">:</span>
            <span class="c1"># The worker got terminated by the torchelastic agent via SIGTERM signal</span>
            <span class="k">return</span> <span class="s2">&quot;TERMINATED&quot;</span>
        <span class="k">elif</span> <span class="n">failure</span> <span class="ow">or</span> <span class="n">worker</span><span class="o">.</span><span class="n">global_rank</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">return_values</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknow worker: </span><span class="si">{</span><span class="n">worker</span><span class="o">.</span><span class="n">global_rank</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_construct_event</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="n">EventSource</span><span class="p">,</span>
        <span class="n">worker</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Worker</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">raw_error</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Event</span><span class="p">:</span>
        <span class="n">wg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">wg</span><span class="o">.</span><span class="n">spec</span>
        <span class="n">md</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;group_world_size&quot;</span><span class="p">:</span> <span class="n">wg</span><span class="o">.</span><span class="n">group_world_size</span><span class="p">,</span>
            <span class="s2">&quot;entry_point&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">get_entrypoint_name</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">worker</span><span class="p">:</span>
            <span class="n">md</span><span class="p">[</span><span class="s2">&quot;local_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">local_rank</span><span class="p">,)</span>
            <span class="n">md</span><span class="p">[</span><span class="s2">&quot;role_rank&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">role_rank</span><span class="p">,)</span>
            <span class="n">md</span><span class="p">[</span><span class="s2">&quot;role_world_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">role_world_size</span><span class="p">,)</span>
            <span class="n">global_rank</span> <span class="o">=</span> <span class="n">worker</span><span class="o">.</span><span class="n">global_rank</span>
            <span class="n">worker_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">worker</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">global_rank</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">worker_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">md_str</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
        <span class="n">metadata</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;run_id&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">rdzv_handler</span><span class="o">.</span><span class="n">get_run_id</span><span class="p">(),</span>
            <span class="s2">&quot;global_rank&quot;</span><span class="p">:</span> <span class="n">global_rank</span><span class="p">,</span>
            <span class="s2">&quot;group_rank&quot;</span><span class="p">:</span> <span class="n">wg</span><span class="o">.</span><span class="n">group_rank</span><span class="p">,</span>
            <span class="s2">&quot;worker_id&quot;</span><span class="p">:</span> <span class="n">worker_id</span><span class="p">,</span>
            <span class="s2">&quot;role&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">role</span><span class="p">,</span>
            <span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">_get_fq_hostname</span><span class="p">(),</span>
            <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="n">state</span><span class="p">,</span>
            <span class="s2">&quot;total_run_time&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_execution_time</span><span class="p">,</span>
            <span class="s2">&quot;rdzv_backend&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">rdzv_handler</span><span class="o">.</span><span class="n">get_backend</span><span class="p">(),</span>
            <span class="s2">&quot;raw_error&quot;</span><span class="p">:</span> <span class="n">raw_error</span><span class="p">,</span>
            <span class="s2">&quot;metadata&quot;</span><span class="p">:</span> <span class="n">md_str</span><span class="p">,</span>
            <span class="s2">&quot;agent_restarts&quot;</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">max_restarts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_restarts</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">Event</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;torchelastic.worker.status.</span><span class="si">{</span><span class="n">state</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_record_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_results</span><span class="p">:</span> <span class="n">RunResult</span><span class="p">):</span>
        <span class="n">is_failed</span> <span class="o">=</span> <span class="n">group_results</span><span class="o">.</span><span class="n">is_failed</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_flakiness_metric</span><span class="p">(</span><span class="n">is_failed</span><span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">spec</span>
        <span class="n">restarts_happened</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_restarts</span> <span class="o">!=</span> <span class="n">spec</span><span class="o">.</span><span class="n">max_restarts</span>
        <span class="n">put_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;workers.</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">role</span><span class="si">}</span><span class="s2">.run_total&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_metric_with_condition</span><span class="p">(</span>
            <span class="s2">&quot;run_success_with_retries&quot;</span><span class="p">,</span> <span class="ow">not</span> <span class="n">is_failed</span> <span class="ow">and</span> <span class="n">restarts_happened</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_metric_with_condition</span><span class="p">(</span>
            <span class="s2">&quot;run_success_no_retries&quot;</span><span class="p">,</span> <span class="ow">not</span> <span class="n">is_failed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">restarts_happened</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_metric_with_condition</span><span class="p">(</span>
            <span class="s2">&quot;run_failed_with_retries&quot;</span><span class="p">,</span> <span class="n">is_failed</span> <span class="ow">and</span> <span class="n">restarts_happened</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_record_metric_with_condition</span><span class="p">(</span>
            <span class="s2">&quot;run_failed_no_retries&quot;</span><span class="p">,</span> <span class="n">is_failed</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">restarts_happened</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_record_metric_with_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">spec</span>
        <span class="k">if</span> <span class="n">condition</span><span class="p">:</span>
            <span class="n">put_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;workers.</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">role</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">put_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;workers.</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">role</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">metric_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_record_flakiness_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_failed</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">is_failed</span><span class="p">:</span>
            <span class="n">flakiness</span> <span class="o">=</span> <span class="mf">100.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">spec</span>
            <span class="n">flakiness</span> <span class="o">=</span> <span class="mf">100.0</span> <span class="o">-</span> <span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_remaining_restarts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">spec</span><span class="o">.</span><span class="n">max_restarts</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">spec</span>

        <span class="n">put_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;workers.</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">role</span><span class="si">}</span><span class="s2">.flakiness&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">flakiness</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_invoke_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">DEFAULT_ROLE</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RunResult</span><span class="p">:</span>
        <span class="c1"># NOTE: currently only works for a single role</span>

        <span class="n">spec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">spec</span>
        <span class="n">role</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">role</span>

        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">] starting workers for entrypoint: </span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">get_entrypoint_name</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_workers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="p">)</span>
        <span class="n">monitor_interval</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">monitor_interval</span>
        <span class="n">rdzv_handler</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">rdzv_handler</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">INIT</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">monitor_interval</span><span class="p">)</span>
            <span class="n">run_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor_workers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">run_result</span><span class="o">.</span><span class="n">state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>

            <span class="n">put_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;workers.</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">.remaining_restarts&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_restarts</span><span class="p">)</span>
            <span class="n">put_metric</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;workers.</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">SUCCEEDED</span><span class="p">:</span>
                <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">] worker group successfully finished.&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; Waiting </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_exit_barrier_timeout</span><span class="si">}</span><span class="s2"> seconds for other agents to finish.&quot;</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exit_barrier</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">run_result</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="ow">in</span> <span class="p">{</span><span class="n">WorkerState</span><span class="o">.</span><span class="n">UNHEALTHY</span><span class="p">,</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">FAILED</span><span class="p">}:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_restarts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">] Worker group </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">. &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_remaining_restarts</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">spec</span><span class="o">.</span><span class="n">max_restarts</span><span class="si">}</span><span class="s2"> attempts left;&quot;</span>
                        <span class="sa">f</span><span class="s2">&quot; will restart worker group&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_remaining_restarts</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_restart_workers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_stop_workers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">FAILED</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_exit_barrier</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">run_result</span>
            <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="n">WorkerState</span><span class="o">.</span><span class="n">HEALTHY</span><span class="p">:</span>
                <span class="c1"># membership changes do not count as retries</span>
                <span class="n">num_nodes_waiting</span> <span class="o">=</span> <span class="n">rdzv_handler</span><span class="o">.</span><span class="n">num_nodes_waiting</span><span class="p">()</span>
                <span class="n">group_rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">group_rank</span>
                <span class="k">if</span> <span class="n">num_nodes_waiting</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">] Detected </span><span class="si">{</span><span class="n">num_nodes_waiting</span><span class="si">}</span><span class="s2"> &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;new nodes from group_rank=</span><span class="si">{</span><span class="n">group_rank</span><span class="si">}</span><span class="s2">; &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;will restart worker group&quot;</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_restart_workers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">] Worker group in </span><span class="si">{</span><span class="n">state</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> state&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="SimpleElasticAgent._exit_barrier"><a class="viewcode-back" href="../../../../agent.html#torchelastic.agent.server.SimpleElasticAgent._exit_barrier">[docs]</a>    <span class="k">def</span> <span class="nf">_exit_barrier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait for ``exit_barrier_timeout`` seconds for all agents to finish</span>
<span class="sd">        executing their local workers (either successfully or not). This</span>
<span class="sd">        acts as a safety guard against user scripts that terminate at different</span>
<span class="sd">        times. This barrier keeps the agent process alive until all workers finish.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Local worker group finished (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">). &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Waiting </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_exit_barrier_timeout</span><span class="si">}</span><span class="s2"> seconds for other agents to finish&quot;</span>
        <span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">store_util</span><span class="o">.</span><span class="n">barrier</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">group_rank</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_worker_group</span><span class="o">.</span><span class="n">group_world_size</span><span class="p">,</span>
                <span class="n">key_prefix</span><span class="o">=</span><span class="n">_TERMINAL_STATE_SYNC_ID</span><span class="p">,</span>
                <span class="n">barrier_timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_exit_barrier_timeout</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Done waiting for other agents. Elapsed: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Error waiting on exit barrier. Elapsed: </span><span class="si">{</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="si">}</span><span class="s2"> seconds&quot;</span>
            <span class="p">)</span></div></div>
</pre></div>

             </article>
             
            </div>
            <footer>
  

  

    <hr>

  

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, PyTorch Elastic Contributors.

    </p>
  </div>
    
      <div>
        Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
      </div>
     

</footer>

          </div>
        </div>

        <div class="pytorch-content-right" id="pytorch-content-right">
          <div class="pytorch-right-menu" id="pytorch-right-menu">
            <div class="pytorch-side-scroll" id="pytorch-side-scroll-right">
              
            </div>
          </div>
        </div>
      </section>
    </div>

  


  

     
       <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
         <script src="../../../../_static/jquery.js"></script>
         <script src="../../../../_static/underscore.js"></script>
         <script src="../../../../_static/doctools.js"></script>
         <script src="../../../../_static/language_data.js"></script>
         <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/katex.min.js"></script>
         <script src="https://cdn.jsdelivr.net/npm/katex@0.11.1/dist/contrib/auto-render.min.js"></script>
         <script src="../../../../_static/katex_autorenderer.js"></script>
     

  

  <script type="text/javascript" src="../../../../_static/js/vendor/popper.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/vendor/bootstrap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
  <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

  <!-- Begin Footer -->

  <div class="container-fluid docs-tutorials-resources" id="docs-tutorials-resources">
    <div class="container">
      <div class="row">
        <div class="col-md-4 text-center">
          <h2>Docs</h2>
          <p>Access comprehensive developer documentation for PyTorch</p>
          <a class="with-right-arrow" href="https://pytorch.org/docs/stable/index.html">View Docs</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Tutorials</h2>
          <p>Get in-depth tutorials for beginners and advanced developers</p>
          <a class="with-right-arrow" href="https://pytorch.org/tutorials">View Tutorials</a>
        </div>

        <div class="col-md-4 text-center">
          <h2>Resources</h2>
          <p>Find development resources and get your questions answered</p>
          <a class="with-right-arrow" href="https://pytorch.org/resources">View Resources</a>
        </div>
      </div>
    </div>
  </div>

  <footer class="site-footer">
    <div class="container footer-container">
      <div class="footer-logo-wrapper">
        <a href="https://pytorch.org/" class="footer-logo"></a>
      </div>

      <div class="footer-links-wrapper">
        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/">PyTorch</a></li>
            <li><a href="https://pytorch.org/get-started">Get Started</a></li>
            <li><a href="https://pytorch.org/features">Features</a></li>
            <li><a href="https://pytorch.org/ecosystem">Ecosystem</a></li>
            <li><a href="https://pytorch.org/blog/">Blog</a></li>
            <li><a href="https://github.com/pytorch/pytorch/blob/master/CONTRIBUTING.md">Contributing</a></li>
          </ul>
        </div>

        <div class="footer-links-col">
          <ul>
            <li class="list-title"><a href="https://pytorch.org/resources">Resources</a></li>
            <li><a href="https://pytorch.org/tutorials">Tutorials</a></li>
            <li><a href="https://pytorch.org/docs/stable/index.html">Docs</a></li>
            <li><a href="https://discuss.pytorch.org" target="_blank">Discuss</a></li>
            <li><a href="https://github.com/pytorch/pytorch/issues" target="_blank">Github Issues</a></li>
            <li><a href="https://pytorch.org/assets/brand-guidelines/PyTorch-Brand-Guidelines.pdf" target="_blank">Brand Guidelines</a></li>
          </ul>
        </div>

        <div class="footer-links-col follow-us-col">
          <ul>
            <li class="list-title">Stay Connected</li>
            <li>
              <div id="mc_embed_signup">
                <form
                  action="https://twitter.us14.list-manage.com/subscribe/post?u=75419c71fe0a935e53dfa4a3f&id=91d0dccd39"
                  method="post"
                  id="mc-embedded-subscribe-form"
                  name="mc-embedded-subscribe-form"
                  class="email-subscribe-form validate"
                  target="_blank"
                  novalidate>
                  <div id="mc_embed_signup_scroll" class="email-subscribe-form-fields-wrapper">
                    <div class="mc-field-group">
                      <label for="mce-EMAIL" style="display:none;">Email Address</label>
                      <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" placeholder="Email Address">
                    </div>

                    <div id="mce-responses" class="clear">
                      <div class="response" id="mce-error-response" style="display:none"></div>
                      <div class="response" id="mce-success-response" style="display:none"></div>
                    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->

                    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_75419c71fe0a935e53dfa4a3f_91d0dccd39" tabindex="-1" value=""></div>

                    <div class="clear">
                      <input type="submit" value="" name="subscribe" id="mc-embedded-subscribe" class="button email-subscribe-button">
                    </div>
                  </div>
                </form>
              </div>

            </li>
          </ul>

          <div class="footer-social-icons">
            <a href="https://www.facebook.com/pytorch" target="_blank" class="facebook"></a>
            <a href="https://twitter.com/pytorch" target="_blank" class="twitter"></a>
            <a href="https://www.youtube.com/pytorch" target="_blank" class="youtube"></a>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <div class="cookie-banner-wrapper">
  <div class="container">
    <p class="gdpr-notice">To analyze traffic and optimize your experience, we serve cookies on this site. By clicking or navigating, you agree to allow our usage of cookies. As the current maintainers of this site, Facebookâ€™s Cookies Policy applies. Learn more, including about available controls: <a href="https://www.facebook.com/policies/cookies/">Cookies Policy</a>.</p>
    <img class="close-button" src="../../../../_static/images/pytorch-x.svg">
  </div>
</div>

  <!-- End Footer -->

  <!-- Begin Mobile Menu -->

  <div class="mobile-main-menu">
    <div class="container-fluid">
      <div class="container">
        <div class="mobile-main-menu-header-container">
          <a class="header-logo" href="https://pytorch.org/" aria-label="PyTorch"></a>
          <a class="main-menu-close-button" href="#" data-behavior="close-mobile-menu"></a>
        </div>
      </div>
    </div>

    <div class="mobile-main-menu-links-container">
      <div class="main-menu">
        <ul>
          <li>
            <a href="https://pytorch.org/get-started">Get Started</a>
          </li>

          <li>
            <a href="https://pytorch.org/ecosystem">Ecosystem</a>
          </li>

          <li>
            <a href="https://pytorch.org/mobile">Mobile</a>
          </li>

          <li>
            <a href="https://pytorch.org/hub">PyTorch Hub</a>
          </li>

          <li>
            <a href="https://pytorch.org/blog/">Blog</a>
          </li>

          <li>
            <a href="https://pytorch.org/tutorials">Tutorials</a>
          </li>

          <li class="resources-mobile-menu-title">
            Docs
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/docs/stable/index.html">PyTorch</a>
            </li>

            <li>
              <a href="https://pytorch.org/audio/stable/index.html">torchaudio</a>
            </li>

            <li>
              <a href="https://pytorch.org/text/stable/index.html">torchtext</a>
            </li>

            <li>
              <a href="https://pytorch.org/vision/stable/index.html">torchvision</a>
            </li>

            <li>
              <a href="https://pytorch.org/elastic/">TorchElastic</a>
            </li>

            <li>
              <a href="https://pytorch.org/serve/">TorchServe</a>
            </li>

            <li>
              <a href="https://pytorch.org/xla">PyTorch on XLA Devices</a>
            </li>
          </ul>

          <li class="resources-mobile-menu-title">
            Resources
          </li>

          <ul class="resources-mobile-menu-items">
            <li>
              <a href="https://pytorch.org/resources">Developer Resources</a>
            </li>

            <li>
              <a href="https://pytorch.org/features">About</a>
            </li>

            <li>
              <a href="https://pytorch.org/hub">Models (Beta)</a>
            </li>

            <li>
              <a href="https://pytorch.org/#community-module">Community</a>
            </li>

            <li>
              <a href="https://discuss.pytorch.org/">Forums</a>
            </li>
          </ul>

          <li>
            <a href="https://github.com/pytorch/pytorch">Github</a>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- End Mobile Menu -->

  <script type="text/javascript" src="../../../../_static/js/vendor/anchor.min.js"></script>

  <script type="text/javascript">
    $(document).ready(function() {
      mobileMenu.bind();
      mobileTOC.bind();
      pytorchAnchors.bind();
      sideMenus.bind();
      scrollToAnchor.bind();
      highlightNavigation.bind();
      mainMenuDropdown.bind();
      filterTags.bind();

      // Add class to links that have code blocks, since we cannot create links in code blocks
      $("article.pytorch-article a span.pre").each(function(e) {
        $(this).closest("a").addClass("has-code");
      });
    })
  </script>
</body>
</html>